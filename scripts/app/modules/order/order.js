define("/modules/order/order",["require","exports","module","/modules/vue/vue","/modules/vue/vue-common","/modules/payment/ga","/modules/vue/vue-validate","/modules/vue/vue-validator"],function(e){var t=e("/modules/vue/vue"),o=e("/modules/vue/vue-common"),n=(e("/modules/payment/ga"),e("/modules/vue/vue-validate"));t.use(e("/modules/vue/vue-validator")),t.filter("pcc",function(e,t){return e.match("¥")?0==t?e.slice(t,1):parseInt(e.slice(t)):0==t?"":e.replace(".","")}),t.component("idcard",{mixins:[n],props:["address"],data:function(){return{ID:null}},methods:{close:function(){mui("#idcardPop").popover("toggle")},addIdcard:function(){var e=this;e.$parent.valiForm(function(){var t=JSON.parse(JSON.stringify(e.address));t.idcard=e.ID,e.$parent.saveAddress(!0,t,function(){mui("#idcardPop").popover("toggle"),setTimeout(function(){e.$parent.checkout()},500)})},e.$idvali)}},template:'<div id="idcardPop" class="mui-popover mui-popover-action mui-popover-bottom mui-popover-idcard">\n   <validator name="idvali">\n      <form novalidate>\n   <ul>\n      <li class="title mui-table-view-cell">\n         实名认证\n         <span class="close fr" @tap="close">×</span>\n      </li>\n      <li class="content">\n         <p>由于国家政策要求实名认证，您的姓名或身份证信息不正确，请修改后再提交！\n         </p>\n         <input  type="text" v-model="ID" v-validate:idcard="{idcard:{rule:false,message:\'请填写正确的身份证号\'},minlength:{rule:1,message:\'应海关要求，购买跨境商品时必须填写身份证号\'}}" placeholder="收货人身份证号（将加密处理）">\n         <button type="button" @tap="addIdcard" class="mui-btn mui-btn-block mui-btn-mm">提交并支付</button>\n      </li>\n   </ul>\n      </form>\n   </validator>\n</div>'});new t({mixins:[o,n],el:"html",data:{title:"订单确认",init:!1,pageData:{},cartItems:{china:[],korea:[],bonded:[],epass:[]},cartCount:{china:null,korea:null,bonded:null,epass:null},cartTotal:{china:null,korea:null,bonded:null,epass:null},couponText:{china:null,korea:null,bonded:null,epass:null},shippingFee:{china:null,korea:null,bonded:null,epass:null},checkoutList:{china:null,korea:null,bonded:null,epass:null},sc:{type:null,list:null},orderAddress:null,addressText:null,couponCode:null,param:{},priceData:{grandTotal:null,usedRewardTotal:null,reward:null,notReward:null,shippingFee:null,discountAmount:null,spent_points_amount:null,duePaid:null,totalQty:null,subtotal:null,is_used_points:null,allowedPoints:null,promotionAmount:null},points:null,address:null,coupon:[],disCoupon:[],couponType:1,warehouType:null,chkStatus:!0,selStatus:!1,couponTotal:0,couponPage:1,gwpItem:null,is_used_points:1,pay:{wx:!1,ali:!1,global:!1,orderId:null,totalAmount:0,time:""},successOrders:[]},methods:{priceChangesClass:function(e,t){return 2==e?1==t?"coupon_china.png":"coupon_chinaOut.png":1==e?1==t?"coupon_kr.png":"coupon_krOut.png":4==e?1==t?"coupon_bonded.png":"coupon_bondedOut.png":7==e?1==t?"coupon_com.png":"coupon_comOut.png":"coupon_out.png"},changePrice:function(e,t){var o;return o=1==e&&t?["¥",parseFloat(t),""]:2==e&&t?["",parseFloat(t),"折"]:[]},changeTxtColor:function(e){return 2==e?"txt-china":1==e?"txt-kr":4==e?"txt-bond":7==e?"txt-com":""},showCouponInfo:function(e){return 2==e?"仅限极速仓使用":1==e?"仅限韩国仓使用":4==e?"仅限保税仓使用":7==e?"全场通用券":!1},toggleMBMasek:function(){var e=this;e.popup({content:e.pageData.rewardDesc,type:"alert",autoClose:!1})},setPrice:function(e){this.priceData.grandTotal=e.usedReward.duePaid,this.priceData.reward=e.usedReward.payback,this.priceData.notRewardTotal=e.notUsedReward.duePaid,this.priceData.notReward=e.notUsedReward.payback,this.priceData.allowedPoints=parseFloat(e.totalReward?e.totalReward:this.priceData.spent_points_amount)},selectCity:function(e){e.target.focus();var t=this,o=new mui.PopPicker({layer:3});o.setData(cityData3),o.show(function(e){t.addressText=(e[0]||{}).text+" "+(e[1]||{}).text+" "+((e[2]||{}).text||(e[1]||{}).text),t.param.province=(e[0]||{}).text,t.param.postcode=(e[0]||{}).value,t.param.city=(e[1]||{}).text,t.param.district=(e[2]||{}).text||(e[1]||{}).text,t.param.provinceId=(e[0]||{}).value})},addClick:function(){this.param={},this.addressText=null},editAddress:function(e){var t=this,o=t.address[e];t.param=_.clone(o),t.addressText=o.province+" "+o.city+" "+o.district},selectAddress:function(e){this.orderAddress=this.address[e],mui.back()},removeAddress:function(e,t){var o=this;o.popup({type:"confirm",content:"确认删除？",ok:function(){o.address.$remove(o.address[t]),o.httpAjax({url:"/h5/address/delete",param:{addressId:e},success:function(t){o.orderAddress&&e==o.orderAddress.addressId&&(o.orderAddress=null),o.param={},0!=mui(".add-address .address-box").length&&(o.da(0),location.reload()),o.popup({content:t.msg})}})}})},sendSave:function(e,t,o){var n=this;n.httpAjax({url:"/h5/address/save",param:t,success:function(t){1==t.code&&(n.initOrder(),e?n.orderAddress.idcard=n.$refs.idcard.ID:mui.back(),o&&o(t)),n.popup({content:t.msg})}})},saveAddress:function(e,t,o){var n=this;t?n.sendSave(e,t,o):n.valiForm(function(){n.sendSave(e,n.param,o)})},da:function(e){var t=this;t.httpAjax({url:"/h5/address/setdefault",param:{addressId:t.address[e].addressId},success:function(){t.orderAddress=t.address[e]}})},changePoints:function(){var e=this;e.is_used_points=e.is_used_points?0:1,1==e.is_used_points?(e.cartTotal.china=e.couponText.china?e.couponText.china.total:null,e.cartTotal.korea=e.couponText.korea?e.couponText.korea.total:null,e.cartTotal.bonded=e.couponText.bonded?e.couponText.bonded.total:null,e.cartTotal.epass=e.couponText.epass?e.couponText.epass.total:null):(e.cartTotal.china=e.couponText.china?e.couponText.china.notTotal:null,e.cartTotal.korea=e.couponText.korea?e.couponText.korea.notTotal:null,e.cartTotal.bonded=e.couponText.bonded?e.couponText.bonded.notTotal:null,e.cartTotal.epass=e.couponText.epass?e.couponText.epass.notTotal:null)},checkout:function(){var e=this;if(e.orderAddress&&e.orderAddress.addressId)if(!e.orderAddress.idcard&&e.isShowID())mui("#idcardPop").popover("toggle");else{var t=e.couponCode;sessionStorage.removeItem("couponCode"),e.httpAjax({url:"/h5/scheckout/placeorder",param:{addressId:e.orderAddress.addressId,couponCode:t,isUsePoints:e.is_used_points},success:function(t){if(1==t.code){e.successOrders=t.data.successOrders,_hmt.push(["_trackEvent","submit_order_pay","去支付"]);var o=0;for(var n in e.cartItems)e.cartItems[n].length>0&&o++;if(1==o&&0!=Number(e.successOrders[0].grandTotal)){var a={grantTotal:e.successOrders[0].grandTotal,time:0==e.successOrders[0].closedLeftTime?"false":e.successOrders[0].closedLeftTime,type:e.successOrders[0].warehouse,orderId:e.successOrders[0].orderId,showCloseBox:!0};e.$refs.pay.payBoxInit(a),mui("#select-pay").popover("show")}else{for(var s=e.successOrders,r=[],d=0;d<s.length;d++)r.push(s[d].orderId);location.href="../payment/payment.html?orderIds="+r.join(",")}}else 4==t.code&&e.popup({content:t.msg})},error:function(){e.popup({content:"程序出错了，支付失败"})},complete:function(t){0==t.code&&e.popup({content:t.msg})}})}else e.popup(e.address&&e.address.length>0?{content:"请选择地址"}:{content:"请填写地址信息"})},showPayBox:function(){var e=this;mui("#select-pay").popover("toggle");var t=e.successOrders[0];t.type=t.warehouse;var o=t.orderId;e.isWeixin()&&"2"==t.type?(e.pay.wx=!0,e.pay.ali=!1,e.pay.wxOk=function(){location.href="/m/payment/payment.html?orderIds="+e.getOrderIds("orderIds")+"&orderId="+o}):(e.pay.wx=!1,e.pay.ali=!0),e.pay.global="1"==t.type?!0:!1},initOrder:function(e){var t=this,o=e?e:"";this.getSearch("itemIds")?o.itemIds=this.getSearch("itemIds"):"",t.orderAddress&&t.orderAddress.addressId&&(o.addressId=t.orderAddress.addressId),t.httpAjax({url:"/h5/scheckout/index",param:o,alert:2,success:function(e){if(1==e.code){t.initAddress(e.data.addressList),t.pageData=e.data.warehouses;for(var o=0;o<t.pageData.length;o++){var n=t.pageData[o];if("2"==n.origin)t.cartItems.china=n.items||[],t.cartCount.china=n.count||0,t.cartTotal.china=n.useReward.total||"￥0.00",t.checkoutList.china=n.info||[],t.couponText.china={type:"极速仓",reward:n.useReward.reward,total:n.useReward.total,notReward:n.notUseReward.reward,notTotal:n.notUseReward.total,couponCount:n.couponCount,selCoupon:n.selectedCouponTitle};else if("1"==n.origin)t.cartItems.korea=n.items||[],t.cartCount.korea=n.items||[],t.cartTotal.korea=n.useReward.total||"￥0.00",t.checkoutList.korea=n.info||[],t.couponText.korea={type:"韩国仓",reward:n.useReward.reward,total:n.useReward.total,notReward:n.notUseReward.reward,notTotal:n.notUseReward.total,couponCount:n.couponCount,selCoupon:n.selectedCouponTitle};else if("4"==n.origin)t.cartItems.bonded=n.items||[],t.cartCount.bonded=n.items||[],t.cartTotal.bonded=n.useReward.total||"￥0.00",t.checkoutList.bonded=n.info||[],t.couponText.bonded={type:"保税仓",reward:n.useReward.reward,total:n.useReward.total,notReward:n.notUseReward.reward,notTotal:n.notUseReward.total,couponCount:n.couponCount,selCoupon:n.selectedCouponTitle};else{if("8"!=n.origin)return!1;t.cartItems.epass=n.items||[],t.cartCount.epass=n.items||[],t.cartTotal.epass=n.useReward.total||"￥0.00",t.checkoutList.epass=n.info||[],t.couponText.epass={type:"韩国仓 ／特快",reward:n.useReward.reward,total:n.useReward.total,notReward:n.notUseReward.reward,notTotal:n.notUseReward.total,couponCount:n.couponCount,selCoupon:n.selectedCouponTitle}}}t.setPrice(e.data.total)}else t.popup({content:e.msg,type:"alert"});t.init=!0},complete:function(e){0==e.code&&t.popup({content:e.msg,type:"alert",autoClose:!1,ok:function(){location.href="../cart/cart.html"}})}})},initAddress:function(e){var t=this;if(t.address=e,!t.orderAddress){for(var o=0;o<t.address.length;o++)t.address[o]&&1==t.address[o].isDefault&&(t.orderAddress=t.address[o]);t.address[0]&&!t.orderAddress&&(t.orderAddress=t.address[0],t.da(0),t.address[0].isDefault=1)}},selectCart:function(e){this.sc.type=e,this.sc.list=this.cartItems[e]},initCouon:function(){var e=this;e.coupon=[],e.couponPage=1,e.getCoupon(function(t){e.couponTotal=t.total,mui("#couponMore").pullRefresh({up:{contentrefresh:"正在加载...",contentnomore:"没有更多数据了",indicators:!1,callback:function(){e.getCoupon()}}})})},getCoupon:function(e){var t=this;t.httpAjax({url:"/h5/scheckout/couponList",param:{warehouses:type},success:function(o){return 1!=o.code?!1:(t.coupon.push(o.data.list),t.couponPage++,e&&e(o.data),6*t.coupon.length>=o.data.total?mui("#couponMore").pullRefresh().endPullupToRefresh(!0):mui("#couponMore").pullRefresh().endPullupToRefresh(),void 0)}})},getCouponList:function(e){var t,o=this;o.warehouType=t="china"==e?2:"korea"==e?1:"bonded"==e?4:"epass"==e?8:0,o.httpAjax({url:"/h5/scheckout/couponList",param:{warehouse:t},success:function(e){if(o.coupon=[],o.disCoupon=[],1==e.code)if(0==e.data.length)o.popup({content:"无可使用的优惠券",type:"alert"});else{for(var t=0;t<e.data.length;){if(1==e.data[t].is_selected){o.chkStatus=!1,o.selStatus=!1;break}t++}for(var n=0;n<e.data.length;n++)1==e.data[n].valid?o.coupon.push(e.data[n]):o.disCoupon.push(e.data[n])}},error:function(){o.popup({content:"优惠券加载失败"})},complete:function(e){0==e.code&&o.popup({content:"无可使用的优惠券"})}})},disUseCoupon:function(){this.popup({content:"无可使用的优惠券"})},useCoupon:function(e,t){var o=this,n=t,a=e,s="",r=o.coupon,d=o.pageData;if(t&&e)o.httpAjax({url:"/h5/scheckout/selectCoupon",param:{coupon_id:n,warehouse:a},success:function(e){if(1==e.code){for(var t=0,u=0;t<r.length;)r[t].id==n?(o.coupon[t].is_selected=1,s=r[t].name):o.coupon[t].is_selected=0,t++;for(;u<d.length;){if(d[u].origin==a){o.pageData[u].selectedCouponTitle=s;break}u++}o.chkStatus=!1,document.getElementById("chk").checked=!1,o.initOrder({get_the_best:0})}else o.$set("couponCode",null),sessionStorage.removeItem("couponCode")},complete:function(e){0==e.code&&o.popup({content:"优惠券使用失败"})}});else{if(null!=t)return!1;o.httpAjax({url:"/h5/scheckout/selectCoupon",param:{coupon_id:"",coupon_code:"",warehouse:a},success:function(e){if(1==e.code){for(var t=0,n=0;t<r.length;)o.coupon[t].is_selected=0,t++;for(;n<d.length;)o.pageData[n].selectedCouponTitle="",n++;o.chkStatus=!0,document.getElementById("chk").checked=!1,o.initOrder({get_the_best:0}),mui.back()}},complete:function(e){0==e.code&&o.popup({content:"优惠券使用失败"})}})}},useCouponCode:function(e,t){{var o=this,n=t,a=e;o.coupon}return t&&""!=t?void o.httpAjax({url:"/h5/scheckout/selectCoupon",param:{coupon_code:n,warehouse:a},success:function(e){1==e.code&&1==e.data.is_success?(o.chkStatus=!1,document.getElementById("chk").checked=!1,mui.back(),o.initOrder({get_the_best:0})):(sessionStorage.removeItem("couponCode"),o.popup({content:e.msg})),o.$set("couponCode",null)}}):void o.popup({content:"优惠码不能为空"})},initView:function(e){var t=mui("#app").view({defaultPage:"#order"});mui(".mui-scroll-wrapper").scroll();var o=t.view,n=e.back;e.back=function(){t.canBack()?t.back():n()},o.addEventListener("pageBeforeShow",function(){}),o.addEventListener("pageShow",function(){}),o.addEventListener("pageBeforeBack",function(){}),o.addEventListener("pageBack",function(){})},isBonded:function(){return!1},isShowID:function(){return!0},changeDesc:function(e){e.target.classList.toggle("show")},isShowCart:function(){return this.cartItems.bonded.length>0||this.cartItems.china.length>0||this.cartItems.korea.length>0||this.cartItems.epass.length>0},qty:function(e){for(var t=0,o=0;o<e.length;o++)t+=Number(e[o].stock);return t}},ready:function(){var e=this;e.$nextTick(function(){mui.init(),e.initView(mui)})},created:function(){var e=this;e.initOrder({get_the_best:1}),e.isWeixin()&&e.getOpenId()}})});
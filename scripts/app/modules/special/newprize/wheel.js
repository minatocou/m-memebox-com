define("/modules/special/newprize/wheel",["require","exports","module","/modules/vue/vue","/modules/vue/vue-common","/modules/app/app","/modules/vue/vue-validate","/modules/vue/vue-validator"],function(e){var t=e("/modules/vue/vue"),a=e("/modules/vue/vue-common"),r=e("/modules/app/app"),i=e("/modules/vue/vue-validate");t.use(e("/modules/vue/vue-validator")),vue=new t({mixins:[a,r,i],el:"html",data:{pageData:null,init:!0,showLogin:!1,showMyPrizes:!1,showAddress:!0,addressText:null,userInfo:{name:null,phone:null,address:null,province:null,city:null,district:null,street:null},showTime:{time:"获取验证码",show:""},param:{phone:"",authCode:""},activity_id:null,type:0,showPrize:!1,prize:!1,is_real:!1,wxShareShow:!1,isRun:!1,isInit:!1},validators:{username:{message:"请输入正确的姓名",check:function(e){return e=e.trim(),""==e||e.length>100||/{|}|\[|]|\/|\\|｝|｛|／/.test(e)?!1:!0}},phone:{message:"请输入正确的手机号",check:function(e){return e=e.trim(),""==e||/1[0-9]{10}/.test(e)?!1:!0}},street:{message:"请输入正确的详细地址",check:function(e){return e=e.trim(),""==e||e.length>100||/{|}|\[|]|\/|\\|｝|｛|／/.test(e)?!1:!0}}},methods:{appShareCall:function(e){1!=e.code||this.isApp()||(_maq.push(["_trackEvent","slyderadventures_share",{Platform:this.getPlatform()}]),this.raffleShare(e))},getAuth:function(){var e=this,t=/^1[34578]{1}\d{9}$/,a=e.param.phone;if("number"==typeof e.showTime.time)return!1;if(0==a.search(t)&&11==a.length){e.showTime.show=!0,e.showTime.time=60;var r=setInterval(function(){e.showTime.time--,0==e.showTime.time&&(clearInterval(r),e.showTime.show=!1,e.showTime.time="获取验证码",r=null)},1e3);e.httpAjax({url:"/h5/sms/getAuth",param:{type:"prize",userName:e.param.phone},success:function(t){e.popup({content:t.msg})},complete:function(t){"0"==t.code&&(clearInterval(r),r=null,e.showTime.show=!1,e.showTime.time="获取验证码")}})}else e.popup({content:"请输入11位正确的手机号码",time:2e3})},userInfoCall:function(e){if(e&&e.data&&e.data.token)this.errorMsg=e.data.token,localStorage.mmToken=e.data.token,this.initPage();else{try{this.errorMsg=JSON.stringify(e)}catch(t){alert(t)}this.initPage()}},login:function(){var e=this,t=18;if(e.pageData.customer){if(!e.pageData.customer.draw_status)return!1;e.start()}else localStorage.source=t,e.isApp()?e.app_login({source:18,type:"register"}):e.h5_login(null,t)},initPage:function(){var e=this;e.httpAjax({url:"/h5/rafflev2/view",param:{activityId:e.activity_id,type:e.type},success:function(t){if(1==t.code){e.showPrize=!0,e.pageData=t.data;var a=e.pageData.raffle.info.description&&e.pageData.raffle.info.description.replace(/\n/g,"/n").split("/n"),r="";a.forEach(function(e){r+="<div>"+e+"</div>"}),e.pageData.raffle.info.description=r,e.setTitle(e.pageData.raffle.info.name),e.isInit||(e.isInit=!0,e.paintWheel(e.pageData.raffle.reward)),e.set_share(e.getShareData()),setTimeout(function(){e.app_setShare(e.getShareData())},50)}}})},paintWheel:function(e){var t=e.length,a=document.getElementById("canvas"),r=.88*a.width,i=a.width*(9/16);if(!a.getContext)return void alert("抱歉！浏览器不支持。");var s=a.getContext("2d");a.width=2*a.width,a.height=a.width;for(var n=function(n){s.save(),s.beginPath(),s.translate(a.width/2,a.height/2),s.moveTo(0,0),s.rotate(360/t*n*Math.PI/180),s.arc(0,0,a.width/2,0,2*Math.PI/t,!1),s.fillStyle=n%2==0?"#fce3e8":"#ffffff",s.fill(),s.lineWidth=.5,s.strokeStyle="#ffffff",s.stroke();var o=new Image;e[n-1].prize_img&&(o.src=e[n-1].prize_img),o.src&&(o.onload=function(){s.save(),s.translate((Math.cos((2*n+1)*Math.PI/t)+16/9)*i,(Math.sin((2*n+1)*Math.PI/t)+16/9)*i),s.moveTo(0,0),s.rotate(Math.PI*(.5+(2*n+1)/t)),s.drawImage(o,-50,-50,100,100),s.restore()});var f=e[n-1].prize;f.length>=10&&(f=f.slice(0,7)+".");var h=f.length;for(l=-(Math.PI/t-30*h/a.width),u=64/a.width,c=0;c<f.length;c++)s.save(),p=f.charAt(c),s.translate(Math.cos(l)*r,0-Math.sin(l)*r),s.moveTo(0,0),s.fillStyle="#d845ac",s.strokeStyle="#d845ac",s.font="28px PingFang SC",s.rotate(Math.PI/2-l),"."==p&&(p="..."),s.fillText(p,0,0),s.strokeText(p,0,0),l-=u,s.restore();s.restore()},o=1;t>=o;o++){var l,u,c,p;n(o)}},wheelGo:function(e){var t,a,r=this;r.pageData.raffle.reward.forEach(function(a,r){a.prize_id==e&&(t=r+1)}),a=2880+180*(1.5-(1+2*t)/r.pageData.raffle.reward.length);var i=document.getElementById("canvas"),s="transform: rotate("+a+"deg);-webkit-transform: rotate("+a+"deg);-o-transform: rotate("+a+"deg);";setTimeout(function(){i.classList.add("anime"),i.setAttribute("style",s)},50)},showDes:function(){var e=this;e.popup({content:e.pageData.raffle.info.description,type:"alert"})},showMyPrize:function(){var e=this;this.pageData.customer?location.href="/m/special/newprize/mine.html?activityId="+e.activity_id+"&type="+e.type:this.login()},address:function(){var e=this;if(this.showAddress=!0,e.pageData.address){console.log(e.pageData.address);for(var t in this.pageData.address)this.userInfo[t]=this.pageData.address[t];this.userInfo.address=this.userInfo.province+" "+this.userInfo.city+" "+this.userInfo.district}},addAddress:function(){var e=this;e.valiForm(function(){e.httpAjax({url:"/h5/rafflev2/editaddress",type:"POST",param:{province:e.userInfo.province,city:e.userInfo.city,district:e.userInfo.district,street:e.userInfo.street,phone:e.userInfo.phone,name:e.userInfo.name,activityId:e.activity_id},success:function(t){1==t.code&&(e.pageData.address=t.data,e.popup({content:"您的信息已提交成功，实物奖品的发放信息会通过短信形式通知您，请耐心等待哦。",type:"alert"}))}})})},selectCity:function(e){e.target.focus();var t=this,a=new mui.PopPicker({layer:3});a.setData(cityData3),a.show(function(e){t.userInfo.address=(e[0]||{}).text+" "+(e[1]||{}).text+" "+((e[2]||{}).text||(e[1]||{}).text),t.userInfo.province=(e[0]||{}).text,t.userInfo.postcode=(e[0]||{}).value,t.userInfo.city=(e[1]||{}).text,t.userInfo.district=(e[2]||{}).text||(e[1]||{}).text,t.userInfo.provinceId=(e[0]||{}).value})},trackPv:function(){_maq.push(["_trackEvent","slyderadventures_page",{Platform:this.getPlatform()}])},raffle:function(){var e=this;_maq.push(["_trackEvent","slyderadventures_paly_check",{Platform:e.getPlatform()}]);var t=document.getElementById("canvas");t.classList.remove("anime"),t.removeAttribute("style"),e.isRun||(e.isRun=!0,e.httpAjax({url:"/h5/rafflev2/draw",type:"POST",param:{activityId:e.activity_id,type:e.type},success:function(t){1==t.code?(_maq.push(["_trackEvent","slyderadventures_paly_success",{Platform:e.getPlatform()}]),e.wheelGo(t.data.prid),setTimeout(function(){var a="";a=0==t.data.type?"艾玛，就差一点，再来一次？":t.msg+'<p style="color: #666;"> 请在“我的奖品”中查看您的奖品哦</p>',e.popup({content:a,type:"alert",btn:"<span>再接再厉</span>"}),e.pageData.raffle=t.data.raffle,e.pageData.customer=t.data.customer,e.isRun=!1},3e3)):3==t.code?(e.isRun=!1,e.popup({content:"亲爱的蜜米，此活动仅新会员专享，您是更尊贵的老会员，更多好的优惠可在您的会员等级中查看哦",type:"alert",btn:"<span>把机会分享给好友</span>",ok:function(){e.isApp()?(e.app_share(e.getShareData()),e.raffleShare()):e.isWeixin()?e.wxShareShow=!0:e.popup({title:" ",content:"请到App内参加抽奖活动",type:"confirm",btn:["关闭","去下载"],ok:function(){e.getAppUrl()}})}})):e.isRun=!1}}))},getShareData:function(){return{title:"幸运好物大放送！",text:"据说今天你会交好运，快来测测手气吧",url:location.href,image:"http://m.cn.memebox.com/images/app/favicon.png"}},raffleShare:function(e){_maq.push(["_trackEvent","slyderadventures_share",{Platform:this.getPlatform()}]);var t=this;t.httpAjax({url:"/h5/rafflev2/share",type:"POST",showLoading:!1,param:{activityId:t.activity_id},success:function(a){if(200==a.code)if(t.isApp())var r=setInterval(function(){t.pageData.customer=a.data.customer,clearInterval(r),location.reload()},6e3);else 1==e.code&&location.reload()}})},closeWxShare:function(){this.wxShareShow=!1},start:function(){var e=this;if(e.isRun)return!1;if(0==this.pageData.raffle.info.status||2==this.pageData.raffle.info.status)return e.popup({content:"不在活动时间内哦亲~",type:"alert"}),!1;if(!this.pageData.customer)return this.login(),!1;if(0==this.pageData.customer.draw_status)return e.popup({content:"您今天的抽奖次数用完啦，明天再来吧~",type:"alert"}),!1;if(1==this.pageData.customer.draw_status){if(this.pageData.customer.can_draw)return e.raffle(),!0;e.popup(e.isApp()?{content:"您今天的抽奖次数用完啦，分享给好友来获得更多抽奖机会吧~",type:"alert",ok:function(){e.isApp()?(e.app_share(e.getShareData()),e.raffleShare()):e.isWeixin()&&(e.wxShareShow=!0)}}:{title:" ",content:"请到App内参加抽奖活动",type:"confirm",btn:["关闭","去下载"],ok:function(){e.getAppUrl()}})}else e.raffle()}},ready:function(){this.init=!0,this.$refs.loading.show=!1},created:function(){var e=this;e.activity_id=e.getSearch("activityId"),e.type=e.getSearch("type"),e.trackPv(),e.isApp()?(localStorage.removeItem("mmToken"),e.app_userinfo()):e.initPage()}})});
define("/modules/special/newprize/prize",["require","exports","module","/modules/vue/vue","/modules/vue/vue-common","/modules/app/app","/modules/vue/vue-validate","/modules/vue/vue-validator"],function(e){var t=e("/modules/vue/vue"),a=e("/modules/vue/vue-common"),i=e("/modules/app/app"),s=e("/modules/vue/vue-validate");t.use(e("/modules/vue/vue-validator")),vue=new t({mixins:[a,i,s],el:"html",data:{pageData:null,init:!0,showLogin:!1,showAddress:!1,addressText:null,userInfo:{name:null,phone:null,address:null,province:null,city:null,district:null,street:null},showTime:{time:"获取验证码",show:""},param:{phone:"",authCode:""},activity_id:null,showPrize:!1,prize:!1,is_real:!1,wxShareShow:!1},validators:{username:{message:"请输入正确的姓名",check:function(e){return e=e.trim(),""==e||e.length>100||/{|}|\[|]|\/|\\|｝|｛|／/.test(e)?!1:!0}},street:{message:"请输入正确的详细地址",check:function(e){return e=e.trim(),""==e||e.length>100||/{|}|\[|]|\/|\\|｝|｛|／/.test(e)?!1:!0}}},methods:{appShareCall:function(e){1!=e.code||this.isApp()||(_maq.push(["_trackEvent","Prize2_share",{prize2:"share"}]),this.raffleShare(e))},checkDraw:function(){var e=["明天再来","分享之后可以抽奖","戳信封抽奖"];if(0==this.pageData.raffle.info.status)return"活动未开始";if(2==this.pageData.raffle.info.status){var t=document.getElementById("prize-btn");return t.className+=" main-btn-read-only","活动已结束"}if(this.pageData.customer){if(0==this.pageData.customer.draw_status){var t=document.getElementById("prize-btn");if(t.className+=" main-btn-read-only",!this.pageData.customer.can_draw)return"活动结束"}else if(1==this.pageData.customer.draw_status&&1==this.pageData.customer.can_draw)return e[2];return e[this.pageData.customer.draw_status]}return"点击登录抽奖"},getAuth:function(){var e=this,t=/^1[34578]{1}\d{9}$/,a=e.param.phone;if("number"==typeof e.showTime.time)return!1;if(0==a.search(t)&&11==a.length){e.showTime.show=!0,e.showTime.time=60;var i=setInterval(function(){e.showTime.time--,0==e.showTime.time&&(clearInterval(i),e.showTime.show=!1,e.showTime.time="获取验证码",i=null)},1e3);e.httpAjax({url:"/h5/sms/getAuth",param:{type:"prize",userName:e.param.phone},success:function(t){e.popup({content:t.msg})},complete:function(t){"0"==t.code&&(clearInterval(i),i=null,e.showTime.show=!1,e.showTime.time="获取验证码")}})}else e.popup({content:"请输入11位正确的手机号码",time:2e3})},userInfoCall:function(e){if(e&&e.data&&e.data.token)this.errorMsg=e.data.token,localStorage.mmToken=e.data.token,this.initPage();else{try{this.errorMsg=JSON.stringify(e)}catch(t){alert(t)}this.initPage()}},login:function(e){var t=this,a=8;if(e)return t.param.source=8,void t.httpAjax({url:"/h5/customer/quickLogin",type:"post",param:t.param,success:function(e){localStorage.mmToken=e.data.token,t.initPage(),t.popup({content:e.msg,time:2e3}),t.showLogin=!1}});if(this.pageData.customer){if(!this.pageData.customer.draw_status)return!1;t.start()}else localStorage.channel=a,this.isApp()?this.app_login({channel:a}):this.h5_login(null,a,function(){t.showLogin=!0})},initPage:function(){var e=this;e.httpAjax({url:"/h5/rafflev2/view",param:{activityId:e.activity_id,type:1},success:function(t){1==t.code&&(e.showPrize=!0,e.pageData=t.data,e.setTitle(e.pageData.raffle.info.name),e.set_share(e.getShareData()),e.app_setShare(e.getShareData()))}})},address:function(){var e=this;if(this.showAddress=!0,e.pageData.address){for(var t in this.pageData.address)this.userInfo[t]=this.pageData.address[t];this.userInfo.address=this.userInfo.province+" "+this.userInfo.city+" "+this.userInfo.district}},addAddress:function(){var e=this;e.valiForm(function(){e.httpAjax({url:"/h5/rafflev2/editaddress",type:"POST",param:{province:e.userInfo.province,city:e.userInfo.city,district:e.userInfo.district,street:e.userInfo.street,phone:e.userInfo.phone,name:e.userInfo.name,activityId:e.activity_id},success:function(t){1==t.code&&(e.pageData.address=t.data)}}),e.showAddress=!1})},hideMask:function(){this.showAddress=!1,this.showLogin=!1},selectCity:function(e){e.target.focus();var t=this,a=new mui.PopPicker({layer:3});a.setData(cityData3),a.show(function(e){t.userInfo.address=(e[0]||{}).text+" "+(e[1]||{}).text+" "+((e[2]||{}).text||(e[1]||{}).text),t.userInfo.province=(e[0]||{}).text,t.userInfo.postcode=(e[0]||{}).value,t.userInfo.city=(e[1]||{}).text,t.userInfo.district=(e[2]||{}).text||(e[1]||{}).text,t.userInfo.provinceId=(e[0]||{}).value})},trackPv:function(){var e=this,t={isWeixin:"wechatprize2pv",isApp:"APPprize2pv",other:"otherprize2pv"},a="";Object.keys(t).forEach(function(t,i){"function"==typeof e[i]&&e[i]()&&(a=t)}),a=a||t.other,_maq.push(["_trackEvent",a,{prize2Pv:a}])},raffle:function(){var e=this;_maq.push(["_trackEvent","Prize2_click",{prize2Raffle:"raffle2"}]),e.httpAjax({url:"/h5/rafflev2/draw",type:"POST",param:{activityId:e.activity_id},success:function(t){if(1==t.code){_maq.push(["_trackEvent","Prize2_click_successful",{prize2Raffle:"raffle2"}]),e.prize=t.msg,e.is_real=t.data.is_real,e.pageData.raffle.myPrize=t.data.raffle.myPrize,e.pageData.customer=t.data.customer;var a=document.querySelector(".move-heart-active"),i=document.querySelector(".gift"),s=document.querySelector(".gift-content"),r=null,n=null;if(!a)return!1;i.className=i.className.replace("gift-jump",""),s.className+=" gift-content-active",r=setTimeout(function(){i.className+=" gift-active",s.style.opacity="1",r=null},100),n=setTimeout(function(){a.className=a.className.replace("move-heart-active",""),n=null},1e3)}}})},getShareData:function(){var e=this;return{title:e.pageData.raffle.info.name,text:"全球知名化妆品平台- 美美箱MEMEBOX电商入驻中国啦!",url:location.href,image:"http://m.cn.memebox.com/images/app/favicon.png"}},raffleShare:function(e){var t=this;t.httpAjax({url:"/h5/rafflev2/share",type:"POST",showLoading:!1,param:{activityId:t.activity_id},success:function(a){if(200==a.code)if(t.isApp()){_maq.push(["_trackEvent","Prize2_share",{prize2:"share"}]);var i=setInterval(function(){t.pageData.customer=a.data.customer,clearInterval(i),location.reload()},6e3)}else 1==e.code&&location.reload()}})},closeWxShare:function(){this.wxShareShow=!1},start:function(){var e=this;if(0==this.pageData.raffle.info.status||2==this.pageData.raffle.info.status)return!1;if(!this.pageData.customer)return console.log(this.pageData.raffle.info.status),this.login(),!1;if(0==this.pageData.customer.draw_status)return!1;if(1==this.pageData.customer.draw_status){if(this.pageData.customer.can_draw)return e.raffle(),!0;if(this.isApp())this.app_share(this.getShareData()),this.raffleShare();else if(this.isWeixin())this.wxShareShow=!0;else{var e=this;this.popup({title:" ",content:"请到App内参加抽奖活动",type:"confirm",btn:['<span style="color:#ccc">关闭</span>',"去下载"],ok:function(){e.getAppUrl()}})}}else e.raffle()}},ready:function(){this.init=!0,this.$refs.loading.show=!1},created:function(){var e=this;e.activity_id=e.getSearch("activityId"),e.trackPv(),e.isApp()?(localStorage.removeItem("mmToken"),e.app_userinfo(),setTimeout(function(){localStorage.mmToken||e.initPage()},500)):e.initPage()}})});
define("/modules/special/redEnvelope/app",["require","exports","module","/modules/vue/vue","/modules/vue/vue-common","/modules/vue/vue-validate","mui","/modules/vue/vue-validator"],function(e){{var t=e("/modules/vue/vue"),o=e("/modules/vue/vue-common"),n=e("/modules/vue/vue-validate");e("mui")}t.use(e("/modules/vue/vue-validator"));new t({mixins:[o,n],el:"html",data:{init:!1,pageData:null,coupon:null,currentStatus:"NORMAL",STATUS_TITLE:{NORMAL:"",HAS_GOT:"恭喜,领券成功",OVERDUE:"红包已派送完,您慢了一步",FAILED:"领券失败"},orderKey:null,formData:{phone:null,code:null},hasPostMes:!1,mesTimer:null,timer:60,share:{title:"宋仲基送你MEMEBOX红包~",desc:"全球知名化妆品平台，比出国买还便宜。",link:location.href,imgUrl:location.origin+"/images/app/special/redEnvelope.jpg"},REQUEST_TIME_OUT:1e4,getAuthTimer:null,getCouponTimer:null,openId:"",wechatOpenId:""},validators:{code:{message:"请输入5位手机验证码",check:function(e){return 5==e.length}},phone:{message:"请输入正确的手机号码",check:function(e){return/^(13[0-9]|17[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i.test(e)}}},methods:{getBaseData:function(){var e=this;return e.orderKey=e.getSearch("key"),e.orderKey?void e.httpAjax({url:"/h5/share/getInfo",showLoading:!1,param:{key:e.orderKey},complete:function(t){t.data&&t.data.description&&(t.data.description=t.data.description.replace(/\r\n/g,"<br>")),t.data.description+="<br>",e.pageData=t.data,e.initPage()}}):(e.popup({content:"无效链接"}),void(this.init=!0))},initPage:function(){this.initStatus(),this.init=!0,this.appendRuleContent(),localStorage.mmToken&&this.getCouponRequest()},initStatus:function(){this.coupon&&this.changeStatus("HAS_GOT"),(this.pageData.isOverdue||0==this.pageData.availableTime)&&this.changeStatus("OVERDUE")},changeStatus:function(e){this.STATUS_TITLE[e]&&(this.currentStatus=e)},checkAndGetCoupon:function(){var e=this;_hmt.push(["_trackEvent","分享红包页面","share 领取"]),e.valiForm(function(){e.blurInput(),e.getCouponRequest()})},getCouponRequest:function(){var e=this;e.getCouponTimer=setTimeout(function(){e.popup({content:"请求失败，请检查网络"})},e.REQUEST_TIME_OUT),e.httpAjax({param:{key:e.orderKey,phone:e.formData.phone,authCode:e.formData.code,openId:e.openId,wechatOpenId:e.wechatOpenId,source:5},url:"/h5/share/getCoupon",success:function(t){if(clearTimeout(e.getCouponTimer),0==t.code&&t.data.failed)return void e.changeStatus("FAILED");var o=t.data;o.token&&(_hmt.push(["_trackEvent","分享红包页面","share 注册成功"]),localStorage.mmToken=o.token),o.coupon&&(o.coupon.phone=e.formData.phone),e.coupon=o.coupon,o.hasGot&&e.changeStatus("HAS_GOT"),localStorage.setItem(e.orderKey,JSON.stringify({pageData:e.pageData,coupon:e.coupon}))},error:function(){clearTimeout(e.getCouponTimer)}})},popRule:function(){this.blurInput(),this.$el.querySelectorAll(".rule-popup-container")[0].style.display="block"},clearlocal:function(){localStorage.clear()},closeRule:function(){this.$el.querySelectorAll(".rule-popup-container")[0].style.display="none"},getPhoneCode:function(){var e=this;e.$validation.phone.valid?(e.blurInput(),e.hasPostMes||(e.getAuthTimer=setTimeout(function(){e.popup({content:"请求失败，请检查网络"})},e.REQUEST_TIME_OUT),e.hasPostMes=!0,e.mesTimer=setInterval(function(){e.timer>0?e.timer--:(clearInterval(e.mesTimer),e.hasPostMes=!1,e.timer=60)},1e3),e.httpAjax({url:"/h5/sms/getAuth",param:{userName:e.formData.phone,type:1},success:function(){clearTimeout(e.getAuthTimer)},error:function(){clearTimeout(e.getAuthTimer),e.popup({content:"发送验证码失败"}),e.hasPostMes=!1,e.timer=60}}))):e.popup({content:e.$validation.phone.messages.phone})},blurInput:function(){for(var e=document.querySelectorAll("input"),t=0;t<e.length;t++)e[t].blur()},appendRuleContent:function(){}},created:function(){var e=this;e.isWeixin()?e.getWxOpenId(function(){e.getBaseData()}):e.getBaseData(),e.set_share(e.share)}});t.filter("toInt",function(e){return parseInt(e)})});
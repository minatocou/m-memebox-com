define("/modules/newcomer/order",["require","exports","module","/modules/vue/vue","/modules/vue/vue-common","/modules/payment/ga","/modules/vue/vue-validate","/modules/vue/vue-validator","/modules/app/app"],function(e){var t=e("/modules/vue/vue"),a=e("/modules/vue/vue-common"),r=(e("/modules/payment/ga"),e("/modules/vue/vue-validate"));t.use(e("/modules/vue/vue-validator"));var o=e("/modules/app/app");t.filter("pcc",function(e,t){return e.match("¥")?0==t?e.slice(t,1):parseInt(e.slice(t)):0==t?"":e.replace(".","")}),t.component("idcard",{mixins:[r],props:["address"],data:function(){return{ID:null,qty:null,total:null}},methods:{close:function(){mui("#idcardPop").popover("toggle")},addIdcard:function(){var e=this;e.$parent.valiForm(function(){var t=JSON.parse(JSON.stringify(e.address));t.idcard=e.ID,e.$parent.saveAddress(!0,t,function(){mui("#idcardPop").popover("toggle"),setTimeout(function(){e.$parent.checkout()},500)})},e.$idvali)}},template:'<div id="idcardPop" class="mui-popover mui-popover-action mui-popover-bottom mui-popover-idcard">\n   <validator name="idvali">\n      <form novalidate>\n   <ul>\n      <li class="title mui-table-view-cell">\n         实名认证\n         <span class="close fr" @tap="close">×</span>\n      </li>\n      <li class="content">\n         <p>由于国家政策要求实名认证，您的姓名或身份证信息不正确，请修改后再提交！\n         </p>\n         <input  type="text" v-model="ID" v-validate:idcard="{idcard:{rule:false,message:\'请填写正确的身份证号\'},minlength:{rule:1,message:\'应海关要求，购买跨境商品时必须填写身份证号\'}}" placeholder="收货人身份证号（将加密处理）">\n         <button type="button" @tap="addIdcard" class="mui-btn mui-btn-block mui-btn-mm">提交并支付</button>\n      </li>\n   </ul>\n      </form>\n   </validator>\n</div>'}),vue=new t({mixins:[a,r,o],el:"html",data:{title:"确认订单",init:!1,pageData:{},orderAddress:null,addressText:null,param:{},address:null,pay:{wx:!1,ali:!1,global:!1,orderId:null,totalAmount:0,time:""},successOrders:[],qty:null,productId:null,optionId:null,value:null,appReport:{},notBuyAgain:"",newcomerPrice:null},methods:{getProType:function(){var e=this,t={isFTZProduct:"bonded",isGlobalProduct:"korea",isLocalProduct:"china"};for(var a in t)if("1"==e.pageData[a])return t[a]},userInfoCall:function(e){var t=this;e&&e.data&&e.data.token&&(this.errorMsg=e.data.token,localStorage.mmToken=e.data.token),setTimeout(function(){localStorage.mmToken?t.initOrder():t.app_login({source:10})},100)},appPayCall:function(e){e&&1==e.code&&e.data&&e.data.orderId&&(this.finishReport(),this.app_orderList({menu:0}))},selectCity:function(e){e.target.focus();var t=this,a=new mui.PopPicker({layer:3});a.setData(cityData3),a.show(function(e){t.addressText=(e[0]||{}).text+" "+(e[1]||{}).text+" "+((e[2]||{}).text||(e[1]||{}).text),t.param.province=(e[0]||{}).text,t.param.postcode=(e[0]||{}).value,t.param.city=(e[1]||{}).text,t.param.district=(e[2]||{}).text||(e[1]||{}).text,t.param.provinceId=(e[0]||{}).value})},addClick:function(){this.param={},this.addressText=null},editAddress:function(e){var t=this,a=t.address[e];t.param=_.clone(a),t.addressText=a.province+" "+a.city+" "+a.district},selectAddress:function(e){this.orderAddress=this.address[e],mui.back()},removeAddress:function(e,t){var a=this;a.popup({type:"confirm",content:"确认删除？",ok:function(){a.address.$remove(a.address[t]),a.httpAjax({url:"/h5/address/delete",param:{addressId:e},success:function(t){a.orderAddress&&e==a.orderAddress.addressId&&(a.orderAddress=null),a.param={},0!=mui(".add-address .address-box").length&&a.da(0),a.popup({content:t.msg})}})}})},sendSave:function(e,t,a){var r=this;r.httpAjax({url:"/h5/address/save",param:t,success:function(t){if(1==t.code){if(r.initAddress(),e)try{r.orderAddress.idcard=r.$refs.idcard.ID}catch(o){console.log(o)}else mui.back();a&&a(t)}r.popup({content:t.msg})}})},saveAddress:function(e,t,a){var r=this;t?r.sendSave(e,t,a):r.valiForm(function(){r.sendSave(e,r.param,a)})},da:function(e){var t=this;t.httpAjax({url:"/h5/address/setdefault",param:{addressId:t.address[e].addressId},success:function(){}})},isShowID:function(){return!0},checkout:function(){var e=this;if(e.orderAddress&&e.orderAddress.addressId)if(!e.orderAddress.idcard&&e.isShowID())mui("#idcardPop").popover("toggle");else{var t=e.getSearch("productId"),a=e.getSearch("configId"),r="h5";e.isIosApp()?r="ios":e.isAndroidApp()&&(r="android");var o={qty:e.qty,addressId:e.orderAddress.addressId,productId:t,configId:a,remark:r};e.optionId&&e.value&&(o.options=o.options||{},o.options[e.optionId]=e.value),e.notBuyAgain=!0,e.httpAjax({url:"/h5/newcomercheckout/placeOrder",param:o,success:function(t){if(15==t.code&&setTimeout(function(){location.href="/m/payment/my_orders.html"},1e3),1==t.code){var a=t.data.grandTotal?parseFloat(t.data.grandTotal).toFixed(2):t.data.grandTotal,r={grantTotal:a,time:0==t.data.closedLeftTime?"false":t.data.closedLeftTime,type:t.data.warehouse,orderId:t.data.increment_id,showCloseBox:!0,wxOk:function(){location.href=e.page+"/payment/my_order.html?orderId="+t.data.increment_id}};if(e.isAppPay()){e.submitReport();var o={4:"FTZ",1:"KR",2:"CN"};e.appReport={inventory:o[t.data.warehouse],order_id:t.data.increment_id,price:e.pageData.newcomerPrice,pay_type:"alipay"},e.app_pay({orderId:t.data.increment_id})}else e.$refs.pay.payBoxInit(r),setTimeout(function(){mui("#select-pay").popover("show")},1e3)}else e.popup({content:t.msg})}})}else e.popup(e.address&&e.address.length>0?{content:"请选择地址"}:{content:"请填写地址信息"})},reducer:function(e,t){return e+t.grouponPrice*this.qty},getOption:function(){$this.groupDetail.grouponerInfo.filter(function(e){return e.customerId==$this.groupDetail.customerInfo.customerId&&$this.isPayOk(e.processState)})},initOrder:function(){var e=this;e.initAddress();var t={productId:e.productId};e.optionId&&e.value&&(t.options={},t.options[e.optionId]=e.value),e.httpAjax({url:"/h5/customer/info",source:10,complete:function(a){a.data&&1==a.data.isNew?e.httpAjax({url:"/h5/newcomer/product",param:t,success:function(t){if(1==t.code){if(e.pageData=t.data,e.pageData&&e.pageData.newcomerPrice&&(e.init=!0,e.pageData.options&&e.pageData.options.length>0)){var a=e.pageData.options.filter(function(t){return t.value==e.value});a.length>0&&(e.pageData.option=a[0].title)}}else e.popup({content:t.msg,type:"alert"});setTimeout(function(){e.initView(mui)},10)}}):e.popup({content:"您不符合新人专享条件",type:"alert",autoClose:!1,ok:function(){e.isApp()?e.app_back():history.back()}})}})},initAddress:function(){var e=this;e.httpAjax({url:"/h5/address/list",source:10,success:function(t){if(e.address=t.data,!e.orderAddress&&e.address){for(var a=0;a<e.address.length;a++)e.address[a]&&1==e.address[a].isDefault&&(e.orderAddress=e.address[a]);e.address[0]&&!e.orderAddress&&(e.orderAddress=e.address[0],e.da(0),e.address[0].isDefault=1)}}})},initView:function(e){var t=mui("#app").view({defaultPage:"#order"});mui(".mui-scroll-wrapper").scroll();var a=(t.view,e.back);e.back=function(){t.canBack()?t.back():a()}},changeDesc:function(e){e.target.classList.toggle("show")},getType:function(){var e=this,t="中国仓";return 1==e.pageData.isFTZProduct?t="保税仓":1==e.pageData.isGlobalProduct&&(t="韩国仓"),t},submitReport:function(){this.getReport("?category=1&eventName=submit_order_pay")},finishReport:function(){this.getReport("?category=1&eventName=finish_order&property="+encodeURIComponent(JSON.stringify(this.appReport)))},getReport:function(e){var t=this,a="h5",r=new Image;if(t.isApp()){var o=t.iosVer()||t.androidVer();a=t.isAndroidApp()?"android_h5":"ios_h5"}r.src="https://report.cn.memebox.com/index.html"+e+"&time="+parseInt((new Date).getTime()/1e3)+"&network=h5&deviceId=h5&platform="+a+"&channel=h5&model=mobile&clientVersion="+o+"&userToken="+localStorage.mmToken+"&userId="+localStorage.mmToken+"&useragent="+navigator.userAgent}},ready:function(){},created:function(){var e=this;e.qty=e.getSearch("qty")||1,e.productId=e.getSearch("productId"),e.productId&&(e.productId=e.productId.replace(/_.*/,"")),e.optionId=e.getSearch("option_id"),e.value=e.getSearch("value"),e.isApp()?(localStorage.removeItem("mmToken"),e.app_userinfo()):(e.isWeixin()&&e.getOpenId(),e.initOrder())}})});